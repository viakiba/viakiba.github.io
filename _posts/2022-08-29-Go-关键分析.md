---
layout: post
title: Golang
categories: [Golang]
description: Go-关键分析
keywords: Golang
tags: Golang
---

掌握golang，除了掌握基本语法，对于一下知识的理解与运用，是熟练使用golang做好业务的关键。

    感谢：https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-select/

<style>
#mindmap {
  display: inline;
  width: 30vw;
  height: 60vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.28.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.13.5/dist/style.css">
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.13.5"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.13.5/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{"type":"heading","depth":0,"payload":{"lines":[0,1]},"content":"KeyWords-Go","children":[{"type":"heading","depth":1,"payload":{"lines":[2,3]},"content":"go","children":[{"type":"heading","depth":2,"payload":{"lines":[4,5]},"content":"启用协程","children":[{"type":"list_item","depth":3,"payload":{"lines":[6,13]},"content":"<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>msg <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>   \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"going\"</span><span class=\"token punctuation\">)</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[13,14]},"content":"<a href=\"https://github.com/bytedance/gopkg/tree/develop/util/gopool\">协程池</a>","children":[{"type":"list_item","depth":3,"payload":{"lines":[15,24]},"content":"<pre class=\"language-go\"><code class=\"language-go\">  gopool<span class=\"token punctuation\">.</span><span class=\"token function\">Go</span><span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>       \n      <span class=\"token comment\">/// do your job  </span>\n      <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n</code></pre>\n"}]}]},{"type":"heading","depth":1,"payload":{"lines":[24,25]},"content":"error ，defer 与 recover","children":[{"type":"heading","depth":2,"payload":{"lines":[26,27]},"content":"error","children":[{"type":"list_item","depth":3,"payload":{"lines":[28,29]},"content":"error 是go定义的接口，并未对其进行规范。"},{"type":"list_item","depth":3,"payload":{"lines":[30,31]},"content":"errors.New()"},{"type":"list_item","depth":3,"payload":{"lines":[32,33]},"content":"fmt.Errorf(&quot;&quot;)"},{"type":"list_item","depth":3,"payload":{"lines":[34,35]},"content":"<a href=\"https://go.googlesource.com/proposal/+/master/design/go2draft-error-values-overview.md\">Go2提案</a>","children":[{"type":"list_item","depth":4,"payload":{"lines":[36,37]},"content":"其中提到了几种 error 的规范方式。"},{"type":"list_item","depth":4,"payload":{"lines":[37,38]},"content":"if err == nil {} 判断"}]}]},{"type":"heading","depth":2,"payload":{"lines":[39,40]},"content":"<a href=\"https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-defer/\">defer</a>","children":[{"type":"bullet_list","depth":3,"payload":{"lines":[41,51]},"content":"","children":[{"type":"list_item","depth":4,"payload":{"lines":[41,42]},"content":"defer 的实现是由编译器和运行时共同完成的"},{"type":"list_item","depth":4,"payload":{"lines":[43,44]},"content":"经常被用于关闭文件描述符、关闭数据库连接以及释放资源"},{"type":"list_item","depth":4,"payload":{"lines":[45,51]},"content":"<pre class=\"language-go\"><code class=\"language-go\">tx <span class=\"token operator\">:=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">Begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">defer</span> tx<span class=\"token punctuation\">.</span><span class=\"token function\">Rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[51,52]},"content":"关键","children":[{"type":"list_item","depth":4,"payload":{"lines":[53,54]},"content":"作用域","children":[{"type":"list_item","depth":5,"payload":{"lines":[54,55]},"content":"只会在当前函数和方法返回之前被调用"},{"type":"list_item","depth":5,"payload":{"lines":[55,56]},"content":"先进后出 先声明的defer语句在后声明的之后执行。"}]},{"type":"list_item","depth":4,"payload":{"lines":[56,57]},"content":"预计算","children":[{"type":"list_item","depth":5,"payload":{"lines":[57,58]},"content":"defer关键字会立刻拷贝函数中引用的外部参数."},{"type":"list_item","depth":5,"payload":{"lines":[58,70]},"content":"<pre class=\"language-go\"><code class=\"language-go\">    <span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        startedAt <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">defer</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span><span class=\"token function\">Since</span><span class=\"token punctuation\">(</span>startedAt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        \n        time<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// $ go run main.go</span>\n    <span class=\"token comment\">// 0s</span>\n</code></pre>\n"},{"type":"list_item","depth":5,"payload":{"lines":[70,82]},"content":"<pre class=\"language-go\"><code class=\"language-go\">    <span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        startedAt <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">defer</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span><span class=\"token function\">Since</span><span class=\"token punctuation\">(</span>startedAt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        \n        time<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// go run main.go</span>\n    <span class=\"token comment\">// 1s</span>\n</code></pre>\n"},{"type":"list_item","depth":5,"payload":{"lines":[82,83]},"content":"虽然调用 defer 关键字时也使用值传递，但是因为拷贝的是函数指针，所以 time.Since(startedAt) 会在 main 函数返回前调用并打印出符合预期的结果。"}]},{"type":"list_item","depth":4,"payload":{"lines":[84,85]},"content":"数据结构"},{"type":"list_item","depth":4,"payload":{"lines":[86,87]},"content":"执行机制","children":[{"type":"list_item","depth":5,"payload":{"lines":[87,88]},"content":"中间代码生成阶段的 cmd/compile/internal/gc.state.stmt 会负责处理程序中的 defer，该函数会根据条件的不同，使用三种不同的机制处理该关键字"}]},{"type":"list_item","depth":4,"payload":{"lines":[89,90]},"content":"分配方式 （三种不同类型 defer 的设计与实现原理）","children":[{"type":"list_item","depth":5,"payload":{"lines":[90,91]},"content":"堆分配 (最初方式，性能最差)"},{"type":"list_item","depth":5,"payload":{"lines":[92,93]},"content":"栈分配 (1.13引入，性能替身百分之30)"},{"type":"list_item","depth":5,"payload":{"lines":[94,95]},"content":"开放编码 (1.14引入，性能做好)","children":[{"type":"list_item","depth":6,"payload":{"lines":[95,96]},"content":"有条件开启"},{"type":"list_item","depth":6,"payload":{"lines":[96,97]},"content":"编译期间判断 defer 关键字、return 语句的个数确定是否开启开放编码优化"},{"type":"list_item","depth":6,"payload":{"lines":[97,98]},"content":"如果函数中 defer 关键字的数量多于 8 个或者 defer 关键字处于 for 循环中，那么我们在这里都会禁用开放编码优化，使用上两节提到的方法处理 defer。"}]}]}]}]},{"type":"heading","depth":2,"payload":{"lines":[99,100]},"content":"panic 与 recover","children":[{"type":"list_item","depth":3,"payload":{"lines":[101,102]},"content":"与 recover 通常一起出现"},{"type":"list_item","depth":3,"payload":{"lines":[103,104]},"content":"调用 panic 后会立刻停止执行当前函数的剩余代码，并在<strong>当前Goroutine</strong> 中递归执行调用方的 defer；"},{"type":"list_item","depth":3,"payload":{"lines":[105,106]},"content":"recover 可以中止 panic 造成的程序崩溃。它是一个只能在 defer 中发挥作用的函数，在其他作用域中调用不会发挥作用；"},{"type":"list_item","depth":3,"payload":{"lines":[107,112]},"content":"<pre class=\"language-go\"><code class=\"language-go\">    <span class=\"token keyword\">func</span> <span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>v <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">pannic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"XXX 错误\"</span><span class=\"token punctuation\">)</span>\n</code></pre>\n"},{"type":"list_item","depth":3,"payload":{"lines":[112,121]},"content":"<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">defer</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> err1 <span class=\"token operator\">:=</span> <span class=\"token function\">recover</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err1 <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">GameSystemLog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"err........\"</span><span class=\"token punctuation\">,</span> zap<span class=\"token punctuation\">.</span><span class=\"token function\">Any</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> err1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre>\n"}]}]},{"type":"heading","depth":1,"payload":{"lines":[121,122]},"content":"<a href=\"https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/\">channel</a> 无锁管道","children":[{"type":"list_item","depth":2,"payload":{"lines":[124,125]},"content":"概述 ： channel是一个缓冲器，遵循先入先出的设计。","children":[{"type":"list_item","depth":3,"payload":{"lines":[125,126]},"content":"先从 Channel 读取数据的 Goroutine 会先接收到数据；"},{"type":"list_item","depth":3,"payload":{"lines":[126,127]},"content":"先向 Channel 发送数据的 Goroutine 会得到先发送数据的权利；"}]},{"type":"list_item","depth":2,"payload":{"lines":[127,128]},"content":"异步与同步","children":[{"type":"list_item","depth":3,"payload":{"lines":[128,129]},"content":"channel的容量会使得其长度为0（同步管道），长度大于0（异步管道&lt;未满的前提&gt;）"},{"type":"list_item","depth":3,"payload":{"lines":[129,130]},"content":"特殊：chan struct{} 类型的异步 Channel — struct{} 类型不占用内存空间，不需要实现缓冲区和直接发送（Handoff）的语义；"}]},{"type":"list_item","depth":2,"payload":{"lines":[130,131]},"content":"ch &lt;- i 发送数据","children":[{"type":"list_item","depth":3,"payload":{"lines":[131,132]},"content":"直接发送","children":[{"type":"list_item","depth":4,"payload":{"lines":[132,133]},"content":"当存在等待的接收者时，通过 runtime.send 直接将数据发送给阻塞的接收者；"},{"type":"list_item","depth":4,"payload":{"lines":[133,134]},"content":"当缓冲区存在空余空间时，将发送的数据写入 Channel 的缓冲区；"},{"type":"list_item","depth":4,"payload":{"lines":[134,135]},"content":"当不存在缓冲区或者缓冲区已满时，等待其他 Goroutine 从 Channel 接收数据；"}]},{"type":"list_item","depth":3,"payload":{"lines":[135,136]},"content":"阻塞发送"}]},{"type":"list_item","depth":2,"payload":{"lines":[136,138]},"content":"接收数据，i &lt;- ch<br>\ni, ok &lt;- ch","children":[{"type":"list_item","depth":3,"payload":{"lines":[138,139]},"content":"直接接收"},{"type":"list_item","depth":3,"payload":{"lines":[140,141]},"content":"阻塞接收"}]},{"type":"list_item","depth":2,"payload":{"lines":[142,143]},"content":"关闭 channel","children":[{"type":"list_item","depth":3,"payload":{"lines":[144,145]},"content":"close(ch)"}]}]},{"type":"heading","depth":1,"payload":{"lines":[146,147]},"content":"select","children":[{"type":"list_item","depth":2,"payload":{"lines":[148,149]},"content":"Go 语言的 select 与操作系统中的 select 比较相似"},{"type":"list_item","depth":2,"payload":{"lines":[150,151]},"content":"特点","children":[{"type":"list_item","depth":3,"payload":{"lines":[152,153]},"content":"与switch结构类似，但是 case 参数不同，select的必是 channel的收发 ."},{"type":"list_item","depth":3,"payload":{"lines":[154,155]},"content":"select 能在 Channel 上进行非阻塞的收发操作；"},{"type":"list_item","depth":3,"payload":{"lines":[156,157]},"content":"select 在遇到多个 Channel 同时响应时，会随机执行一种情况；"}]},{"type":"list_item","depth":2,"payload":{"lines":[157,158]},"content":"阻塞","children":[{"type":"list_item","depth":3,"payload":{"lines":[158,159]},"content":"直接阻塞","children":[{"type":"list_item","depth":4,"payload":{"lines":[160,161]},"content":"空 select 会直接阻塞当前 Goroutine，导致 Goroutine 进入无法被唤醒的永久休眠状态。"}]},{"type":"list_item","depth":3,"payload":{"lines":[161,162]},"content":"单一管道","children":[{"type":"list_item","depth":4,"payload":{"lines":[163,164]},"content":"如果当前的 select 条件只包含一个 case 。"},{"type":"list_item","depth":4,"payload":{"lines":[164,165]},"content":"当 case 中的 Channel 是空指针时，会直接挂起当前 Goroutine 并陷入永久休眠。"}]},{"type":"list_item","depth":3,"payload":{"lines":[165,166]},"content":"非阻塞","children":[{"type":"list_item","depth":4,"payload":{"lines":[167,168]},"content":"发送","children":[{"type":"list_item","depth":5,"payload":{"lines":[168,169]},"content":"runtime.selectnbsend，它为我们提供了向 Channel 非阻塞地发送数据的能力"},{"type":"list_item","depth":5,"payload":{"lines":[169,170]},"content":"在不存在接收方或者缓冲区空间不足时，当前 Goroutine 都不会阻塞而是会直接返回"}]},{"type":"list_item","depth":4,"payload":{"lines":[171,172]},"content":"接收","children":[{"type":"list_item","depth":5,"payload":{"lines":[172,173]},"content":"从 Channel 中接收数据可能会返回一个或者两个值"},{"type":"list_item","depth":5,"payload":{"lines":[173,174]},"content":"runtime.selectnbrecv 会直接忽略返回的布尔值，而 runtime.selectnbrecv2 会将布尔值回传给调用方"}]},{"type":"list_item","depth":4,"payload":{"lines":[175,176]},"content":"在默认情况下，编译器会使用如下的流程处理 select 语句","children":[{"type":"list_item","depth":5,"payload":{"lines":[176,177]},"content":"https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-select/#%e5%b8%b8%e8%a7%81%e6%b5%81%e7%a8%8b"},{"type":"list_item","depth":5,"payload":{"lines":[177,178]},"content":"随机生成一个遍历的轮询顺序 pollOrder 并根据 Channel 地址生成锁定顺序 lockOrder；"},{"type":"list_item","depth":5,"payload":{"lines":[178,179]},"content":"根据 pollOrder 遍历所有的 case 查看是否有可以立刻处理的 Channel；"},{"type":"list_item","depth":5,"payload":{"lines":[179,180]},"content":"如果存在，直接获取 case 对应的索引并返回；"},{"type":"list_item","depth":5,"payload":{"lines":[180,181]},"content":"如果不存在，创建 runtime.sudog 结构体，将当前 Goroutine 加入到所有相关 Channel 的收发队列，并调用 runtime.gopark 挂起当前 Goroutine 等待调度器的唤醒；"},{"type":"list_item","depth":5,"payload":{"lines":[181,182]},"content":"当调度器唤醒当前 Goroutine 时，会再次按照 lockOrder 遍历所有的 case，从中查找需要被处理的 runtime.sudog 对应的索引；"}]}]}]}]},{"type":"heading","depth":1,"payload":{"lines":[183,184]},"content":"for 与 range","children":[{"type":"heading","depth":2,"payload":{"lines":[185,186]},"content":"fori（经典循环）","children":[{"type":"list_item","depth":3,"payload":{"lines":[187,192]},"content":"<pre class=\"language-go\"><code class=\"language-go\">    <span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[192,193]},"content":"range (范围循环)","children":[{"type":"list_item","depth":3,"payload":{"lines":[193,201]},"content":"<pre class=\"language-go\"><code class=\"language-go\">    arr <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">for</span> index<span class=\"token punctuation\">,</span> value <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> arr <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"index 是 \"</span> <span class=\"token operator\">+</span> strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Itoa</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value 是 \"</span> <span class=\"token operator\">+</span> strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Itoa</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre>\n"},{"type":"list_item","depth":3,"payload":{"lines":[201,215]},"content":"<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// 值得注意的是 不要 引用临时的 v 变量的地址 他是循环使用的。</span>\n<span class=\"token comment\">// &amp;arr[i] 进行替代</span>\narr <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">}</span>\nnewArr <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> v <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> arr <span class=\"token punctuation\">{</span>\n    newArr <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>newArr<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> v <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> newArr <span class=\"token punctuation\">{</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>v<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// 输出： 3 3 3</span>\n</code></pre>\n"},{"type":"list_item","depth":3,"payload":{"lines":[215,216]},"content":"简单的经典循环相比，范围循环在 Go 语言中更常见。"},{"type":"list_item","depth":3,"payload":{"lines":[217,218]},"content":"编译器会在编译期间将所有 for-range 循环变成经典循环。"}]},{"type":"heading","depth":2,"payload":{"lines":[219,220]},"content":"array / slice","children":[{"type":"list_item","depth":3,"payload":{"lines":[221,233]},"content":"<pre class=\"language-go\"><code class=\"language-go\">    arr <span class=\"token operator\">:=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">//数组前面会指定长度</span>\n    <span class=\"token keyword\">for</span> index<span class=\"token punctuation\">,</span> value <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> arr <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"index 是 \"</span> <span class=\"token operator\">+</span> strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Itoa</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value 是 \"</span> <span class=\"token operator\">+</span> strconv<span class=\"token punctuation\">.</span><span class=\"token function\">Itoa</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 切片初始化 几种方式</span>\n    <span class=\"token comment\">// slice1 := make([]int, len, cap)</span>\n    <span class=\"token comment\">// slice2 := []int{10, 20, 30, 40}</span>\n    <span class=\"token comment\">// 切片创建新的切片 </span>\n    <span class=\"token comment\">// slice3 := slice2[:]</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[235,236]},"content":"string","children":[{"type":"list_item","depth":3,"payload":{"lines":[237,244]},"content":"<pre class=\"language-go\"><code class=\"language-go\">str <span class=\"token operator\">:=</span> <span class=\"token string\">\"12345\"</span>\n<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span>v <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> str <span class=\"token punctuation\">{</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[244,245]},"content":"map","children":[{"type":"list_item","depth":3,"payload":{"lines":[246,257]},"content":"<pre class=\"language-go\"><code class=\"language-go\">    hash <span class=\"token operator\">:=</span> <span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"3\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> hash <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">println</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[257,258]},"content":"channel","children":[{"type":"list_item","depth":3,"payload":{"lines":[259,268]},"content":"<pre class=\"language-go\"><code class=\"language-go\"> c <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n c <span class=\"token operator\">&lt;-</span> <span class=\"token number\">1</span>\n <span class=\"token keyword\">for</span> e <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> c <span class=\"token punctuation\">{</span>\n     fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n     <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span>\n     <span class=\"token comment\">// 不关闭 会一直等待循环 channel</span>\n <span class=\"token punctuation\">}</span> \n</code></pre>\n"}]}]},{"type":"heading","depth":1,"payload":{"lines":[270,271]},"content":"并发","children":[{"type":"heading","depth":2,"payload":{"lines":[274,275]},"content":"Mutex (互斥锁)","children":[{"type":"list_item","depth":3,"payload":{"lines":[276,290]},"content":"<pre class=\"language-go\"><code class=\"language-go\">state <span class=\"token operator\">:=</span> <span class=\"token number\">0</span>\nlock <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>sync<span class=\"token punctuation\">.</span>Mutex<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">--</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">defer</span> lock<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        state <span class=\"token operator\">=</span> state <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\ntime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Second <span class=\"token operator\">*</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\nfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[290,291]},"content":"RWMutex (读写锁)","children":[{"type":"list_item","depth":3,"payload":{"lines":[292,313]},"content":"<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// 只读的地方使用读锁  lock.RLock()</span>\n<span class=\"token comment\">// 有写的地方用写锁    lock.Lock()</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">TestXXXXX</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\nstate <span class=\"token operator\">:=</span> <span class=\"token number\">0</span>\nlock <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>sync<span class=\"token punctuation\">.</span>RWMutex<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">--</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">defer</span> lock<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        state <span class=\"token operator\">=</span> state <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">RLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">defer</span> lock<span class=\"token punctuation\">.</span><span class=\"token function\">RUnlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\ntime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>Second <span class=\"token operator\">*</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\nfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xxxxxxxxxxxxxxxxx\"</span><span class=\"token punctuation\">)</span>\nfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[316,317]},"content":"WaitGroup","children":[{"type":"list_item","depth":3,"payload":{"lines":[318,330]},"content":"<pre class=\"language-go\"><code class=\"language-go\">wg <span class=\"token operator\">:=</span> sync<span class=\"token punctuation\">.</span>WaitGroup<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\nwg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 调用 done 三次，wait 放行</span>\n<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        time<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span><span class=\"token function\">Duration</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n        wg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\nwg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"over\"</span><span class=\"token punctuation\">)</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[332,333]},"content":"once","children":[{"type":"list_item","depth":3,"payload":{"lines":[334,344]},"content":"<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// 保证在 Go 程序运行期间的某段代码只会执行一次</span>\no <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>sync<span class=\"token punctuation\">.</span>Once<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n    o<span class=\"token punctuation\">.</span><span class=\"token function\">Do</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"only once\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[344,345]},"content":"Cond","children":[{"type":"list_item","depth":3,"payload":{"lines":[346,378]},"content":"<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> status <span class=\"token builtin\">int64</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">Test_Cond</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>T<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    c <span class=\"token operator\">:=</span> sync<span class=\"token punctuation\">.</span><span class=\"token function\">NewCond</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>sync<span class=\"token punctuation\">.</span>Mutex<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">go</span> <span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    time<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">go</span> <span class=\"token function\">broadcast</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span>\n\n    ch <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> os<span class=\"token punctuation\">.</span>Signal<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    signal<span class=\"token punctuation\">.</span><span class=\"token function\">Notify</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">,</span> os<span class=\"token punctuation\">.</span>Interrupt<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">&lt;-</span>ch\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">broadcast</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>sync<span class=\"token punctuation\">.</span>Cond<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    c<span class=\"token punctuation\">.</span>L<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    atomic<span class=\"token punctuation\">.</span><span class=\"token function\">StoreInt64</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>status<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    c<span class=\"token punctuation\">.</span><span class=\"token function\">Broadcast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    c<span class=\"token punctuation\">.</span>L<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">*</span>sync<span class=\"token punctuation\">.</span>Cond<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    c<span class=\"token punctuation\">.</span>L<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> atomic<span class=\"token punctuation\">.</span><span class=\"token function\">LoadInt64</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">{</span>\n        c<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"listen\"</span><span class=\"token punctuation\">)</span>\n    c<span class=\"token punctuation\">.</span>L<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[378,379]},"content":"context","children":[{"type":"list_item","depth":3,"payload":{"lines":[380,422]},"content":"<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">/** 拿 context 做并发控制，核心是利用\nctx, cancel := context.WithCancel(context.Background())\nctx, timeout := context.WithTimeout(context.Background(), 1*time.Second)\nctx, deadline := context.WithDeadline(context.Background(), time.Now().Add(1*time.Second))\n\n\ncancel , timeout ,deadline 发起的 通知，然后所以监听 ctx.Done() 管道的协程就会终止。\n*/</span>\n<span class=\"token keyword\">package</span> main\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"context\"</span>\n    <span class=\"token string\">\"fmt\"</span>\n    <span class=\"token string\">\"sync\"</span>\n    <span class=\"token string\">\"time\"</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> wg sync<span class=\"token punctuation\">.</span>WaitGroup\n    ctx<span class=\"token punctuation\">,</span> stop <span class=\"token operator\">:=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">WithCancel</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">Background</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    wg<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">defer</span> wg<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">worker</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    time<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token operator\">*</span>time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span> <span class=\"token comment\">//工作3秒</span>\n    <span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//3秒后发出停止指令</span>\n    wg<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">worker</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">select</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"下班咯~~~\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n            fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"认真摸鱼中，请勿打扰...\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        time<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">*</span>time<span class=\"token punctuation\">.</span>Second<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]}]},{"type":"heading","depth":1,"payload":{"lines":[422,423]},"content":"GC内存","children":[{"type":"heading","depth":2,"payload":{"lines":[424,425]},"content":"内存分配"},{"type":"heading","depth":2,"payload":{"lines":[426,427]},"content":"栈内存管理"},{"type":"heading","depth":2,"payload":{"lines":[428,429]},"content":"垃圾收集"}]},{"type":"heading","depth":1,"payload":{"lines":[431,432]},"content":"其他","children":[{"type":"list_item","depth":2,"payload":{"lines":[433,434]},"content":"其实 go 的效率高很大程度上来源于 io 是非阻塞的，这一块可以看一下 go 的调度与网络轮训器实现，他们是go的根本。"}]}]},{})</script>